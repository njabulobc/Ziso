{% extends "base.html" %}
{% block title %}{{ page_config.title }} · Ziso Intelligence{% endblock %}

{% block content %}
<section class="space-y-8">
    <div class="rounded-3xl bg-gradient-to-br from-indigo-500 via-indigo-500/90 to-purple-600 px-8 py-10 text-white shadow-xl">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div class="space-y-3">
                <p class="text-3xl">{{ page_config.icon }}</p>
                <div>
                    <h1 class="text-3xl font-semibold tracking-tight sm:text-4xl">{{ page_config.title }}</h1>
                    <p class="mt-3 max-w-2xl text-base text-indigo-100">
                        {{ page_config.description }}
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-3 text-indigo-100">
                {% if breadcrumbs %}
                    <nav class="flex items-center text-sm font-medium" aria-label="Breadcrumb">
                        {% for crumb in breadcrumbs %}
                            {% if not forloop.first %}
                                <span class="px-2 text-indigo-200">/</span>
                            {% endif %}
                            {% if crumb.url %}
                                <a href="{{ crumb.url }}" class="transition hover:text-white">{{ crumb.label }}</a>
                            {% else %}
                                <span class="text-white/90">{{ crumb.label }}</span>
                            {% endif %}
                        {% endfor %}
                    </nav>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_320px]">
        <div class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm">
            <form id="resource-form" method="post" action="{{ form_action }}" enctype="multipart/form-data" novalidate class="space-y-8">
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700" role="alert">
                        {% for error in form.non_field_errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="hidden rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700" data-field-error="__all__"></div>

                <div class="grid gap-6 lg:grid-cols-2 lg:gap-8">
                    {% for field in form %}
                        <div class="space-y-2" data-field-wrapper="{{ field.name }}">
                            <div class="flex items-center justify-between gap-3">
                                <label for="{{ field.id_for_label }}" class="text-sm font-semibold text-slate-700">
                                    {{ field.label }}
                                    {% if field.field.required %}
                                        <span class="ml-1 rounded-full bg-indigo-100 px-2 py-0.5 text-xs font-medium text-indigo-600">Required</span>
                                    {% endif %}
                                </label>
                                {% if field.help_text %}
                                    <p class="text-xs text-slate-500">{{ field.help_text }}</p>
                                {% endif %}
                            </div>
                            <div class="space-y-1">
                                {{ field }}
                                {% if field.errors %}
                                    <p class="text-sm text-rose-600">{{ field.errors|join:' ' }}</p>
                                {% endif %}
                                <p class="hidden text-sm text-rose-600" data-field-error="{{ field.name }}"></p>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="flex flex-col gap-4 border-t border-slate-200 pt-6 sm:flex-row sm:items-center sm:justify-between">
                    <p class="text-sm text-slate-500">All submissions are encrypted and recorded with a full audit trail.</p>
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                        <button type="reset" class="inline-flex items-center justify-center rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Reset</button>
                        <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-full bg-indigo-600 px-6 py-2.5 text-sm font-semibold text-white shadow-sm transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500" data-submit-button>
                            <span data-submit-label>{{ submit_label }}</span>
                            <span class="hidden items-center gap-2" data-submit-spinner>
                                <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                                    <circle class="opacity-25" cx="12" cy="12" r="10"></circle>
                                    <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke-linecap="round"></path>
                                </svg>
                                Processing…
                            </span>
                        </button>
                    </div>
                </div>
            </form>

            <div id="form-status" class="mt-8 hidden rounded-2xl border px-4 py-3 text-sm" role="status" aria-live="polite"></div>
        </div>

        <aside class="space-y-6 rounded-3xl border border-indigo-100 bg-indigo-50/60 p-6 text-sm text-indigo-900">
            <div>
                <h2 class="text-sm font-semibold uppercase tracking-wider text-indigo-500">Submission guide</h2>
                <p class="mt-3 leading-relaxed text-indigo-900/80">Use descriptive file names and review numeric fields before submitting. Attachments support PDF, JPEG, and PNG formats up to 10MB.</p>
            </div>
            <div class="rounded-2xl border border-indigo-200 bg-white/60 p-4">
                <h3 class="text-sm font-semibold text-indigo-600">Workflow tips</h3>
                <ul class="mt-3 space-y-2 text-indigo-900/80">
                    <li class="flex items-start gap-2"><span class="mt-1 h-1.5 w-1.5 flex-none rounded-full bg-indigo-400"></span>Press <span class="font-semibold">Tab</span> to move quickly between fields.</li>
                    <li class="flex items-start gap-2"><span class="mt-1 h-1.5 w-1.5 flex-none rounded-full bg-indigo-400"></span>All records are versioned – resubmitting updates the audit history.</li>
                    <li class="flex items-start gap-2"><span class="mt-1 h-1.5 w-1.5 flex-none rounded-full bg-indigo-400"></span>Need to pause? Save the draft in your secure notes with the reference ID.</li>
                </ul>
            </div>
            <div class="rounded-2xl border border-indigo-200 bg-white/60 p-4">
                <h3 class="text-sm font-semibold text-indigo-600">Support</h3>
                <p class="mt-2 text-indigo-900/80">For compliance escalations, contact the investigations desk via <a href="mailto:support@ziso.example" class="font-semibold text-indigo-600 underline-offset-2 hover:underline">support@ziso.example</a>.</p>
            </div>
        </aside>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    (function() {
        const form = document.getElementById('resource-form');
        if (!form || !window.fetch) return;

        const status = document.getElementById('form-status');
        const submitButton = form.querySelector('[data-submit-button]');
        const submitLabel = form.querySelector('[data-submit-label]');
        const submitSpinner = form.querySelector('[data-submit-spinner]');

        const resetErrors = () => {
            form.querySelectorAll('[data-field-error]').forEach(el => {
                el.textContent = '';
                el.classList.add('hidden');
            });
            form.querySelectorAll('[data-field-input]').forEach(input => {
                input.classList.remove('ring-2', 'ring-rose-500', 'border-rose-400');
            });
        };

        const setStatus = (type, message) => {
            if (!status) return;
            status.classList.remove('hidden');
            status.textContent = message;
            status.className = 'mt-8 rounded-2xl border px-4 py-3 text-sm';
            if (type === 'success') {
                status.classList.add('border-emerald-200', 'bg-emerald-50', 'text-emerald-700');
            } else if (type === 'error') {
                status.classList.add('border-rose-200', 'bg-rose-50', 'text-rose-700');
            } else {
                status.classList.add('border-slate-200', 'bg-slate-50', 'text-slate-600');
            }
        };

        const toggleSubmitting = (isSubmitting) => {
            if (!submitButton || !submitLabel || !submitSpinner) return;
            submitButton.disabled = isSubmitting;
            submitButton.classList.toggle('opacity-70', isSubmitting);
            submitButton.classList.toggle('cursor-not-allowed', isSubmitting);
            submitButton.setAttribute('aria-busy', String(isSubmitting));
            submitButton.setAttribute('aria-disabled', String(isSubmitting));
            submitLabel.classList.toggle('hidden', isSubmitting);
            submitSpinner.classList.toggle('hidden', !isSubmitting);
        };

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            resetErrors();
            toggleSubmitting(true);
            if (status) {
                status.classList.add('hidden');
                status.textContent = '';
            }

            const formData = new FormData(form);
            const endpoint = form.getAttribute('action') || window.location.href;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    setStatus('success', data.message || 'Record saved successfully.');
                    form.reset();
                    resetErrors();
                } else {
                    setStatus('error', data.message || 'Please review the highlighted fields.');
                    if (data.errors) {
                        Object.entries(data.errors).forEach(([fieldName, messages]) => {
                            const errorElement = form.querySelector(`[data-field-error="${fieldName}"]`);
                            if (errorElement) {
                                errorElement.textContent = Array.isArray(messages) ? messages.join(' ') : messages;
                                errorElement.classList.remove('hidden');
                            }
                            const input = form.querySelector(`[data-field-input="${fieldName}"]`);
                            if (input) {
                                input.classList.add('ring-2', 'ring-rose-500', 'border-rose-400');
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Submission error', error);
                setStatus('error', 'A network error occurred. Please retry in a moment.');
            } finally {
                toggleSubmitting(false);
            }
        });
    })();
</script>
{% endblock %}
